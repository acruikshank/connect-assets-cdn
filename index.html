<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>connect-assets-cdn by jgable</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/jgable/connect-assets-cdn">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/jgable/connect-assets-cdn/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/jgable/connect-assets-cdn/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>connect-assets-cdn</h1>
          <p>A helper module for connect-assets to upload your files to Amazon S3</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/jgable">jgable</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h3>Installation <a href="http://travis-ci.org/jgable/connect-assets-cdn"><img src="https://secure.travis-ci.org/jgable/connect-assets-cdn.png" alt="Build Status"></a>
</h3>

<p><code>npm install connect-assets-cdn</code></p>

<h3>Usage (Cake Task)</h3>

<p>To create a Cake task to upload new assets, follow this example.</p>

<p><strong>/s3.js</strong></p>

<pre><code>require("coffee-script");

var uploader = require("./src/s3AssetUpload");

uploader.upload(console.log, function(err, uploaded) {
    if(err) {
        return console.log("Error uploading: " + err.message);
        process.exit(1);
    }

    console.log("Completed");
    process.exit(0);
});
</code></pre>

<p><strong>/src/s3AssetUpload.coffee</strong></p>

<pre><code>express = require 'express'
assets = require "connect-assets"
jsPaths = require "connect-assets-jspaths"

{AssetsCDN} = require "connect-assets-cdn"

# Either create a config file like here or set this to 
# an object with amazon key, secret and bucket values
# Also should have the assetsRoot; e.g. //s3.amazonaws.com/myBucket
config = require "./config"

primeCSS = (assets) -&gt;
    # We only have one file to pre-compile for css
    # You might need to add more for your situation;
    # whatever you reference in your views should be 
    # referenced like this here
    assets.instance.options.helperContext.css "prod"

upload = (log, done) -&gt;

    # Set up a fake express server so we can load connect-assets
    app = express()

    opts = 
        # TODO: Set your assetsRoot
        servePath: config.assetsRoot

    app.use assets opts

    # Prime the CSS files
    primeCSS assets
    # Prime the JS files
    jsPaths assets

    # TODO: Set these from your config
    {key, secret, bucket} = config.amazon

    # Create our cdn manager and upload
    cdn = new AssetsCDN {assets, key, secret, bucket, log}

    cdn.upload done

module.exports = {upload}
</code></pre>

<p><strong>/Cakefile</strong> </p>

<pre><code>task 's3', 'Upload builtAssets', -&gt;
    # Set production NODE_ENV
    currentEnv = process.env
    currentEnv.NODE_ENV = "production"

    server = spawn 'node', ['s3.js'],
      env: currentEnv

    server.stdout.pipe process.stdout
    server.stderr.pipe process.stderr
</code></pre>

<h3>Usage (Before Starting Server)</h3>

<pre><code># You can also upload new assets before starting the server...

assets = require 'connect-assets'
{AssetsCDN} = require 'connect-assets-cdn'

# Snip ...

app.use assets
    servePath: '//s3.amazonaws.com/S3_Bucket'

# You should probably only upload for production
if process.env.NODE_ENV == "production"

    cdn = new AssetsCDN 
        assets: assets
        key: "S3_Key"
        secret: "S3_Secret"
        bucket: "S3_Bucket"

    cdn.upload (err, uploadedPaths) -&gt;
        throw err if err

        app.listen 3000, (err) -&gt;
            console.log "Server started"
</code></pre>

<h3>TODO:</h3>

<ul>
<li>Better uploader tests</li>
</ul><h3>Thanks</h3>

<p>Made possible thanks to <a href="https://github.com/TrevorBurnham/connect-assets">connect-assets</a>, <a href="https://github.com/learnboost/knox">knox</a>.</p>

<h3>Copyright</h3>

<p>Created by <a href="http://jacobgable.com">Jacob Gable</a>.  MIT License; no attribution required.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>